<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1-1 ç­‰å·®æ•¸åˆ—ï¼šFirebase é›²ç«¯æŒ‘æˆ°è³½</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background: #eef2f3; display: flex; justify-content: center; padding: 20px; }
        #game-container { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 100%; max-width: 650px; text-align: center; }
        .hidden { display: none; }
        .heart { color: #ff4757; font-size: 28px; }
        .option-btn { display: block; width: 100%; margin: 12px 0; padding: 16px; font-size: 18px; border: 2px solid #70a1ff; border-radius: 12px; cursor: pointer; background: white; transition: 0.2s; }
        .option-btn:hover { background: #70a1ff; color: white; }
        #timer-bar { height: 12px; background: #2ed573; width: 100%; border-radius: 6px; transition: width 0.4s linear; }
        .review-card { text-align: left; background: #fffaf0; padding: 15px; margin-top: 10px; border-left: 5px solid #ffa502; border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; background: #fff; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
        th { background: #1e90ff; color: white; }
        input { padding: 10px; margin: 5px; width: 70%; border: 1px solid #ccc; border-radius: 5px; }
        .btn-action { background: #1e90ff; color: white; border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer; font-size: 16px; }
    </style>
</head>
<body>

<div id="game-container">
    <h1 id="main-title">1-1 ç­‰å·®æ•¸åˆ—æŒ‘æˆ°</h1>

    <div id="start-screen">
        <h3>ğŸ† å…¨æ ¡ç©åˆ†æ’è¡Œæ¦œ (Firebase ç›´é€£)</h3>
        <table id="leaderboard">
            <thead><tr><th>åæ¬¡</th><th>ç­ç´š</th><th>å§“å</th><th>åˆ†æ•¸</th></tr></thead>
            <tbody id="leaderboard-body"><tr><td colspan="4">è¼‰å…¥ä¸­...</td></tr></tbody>
        </table>
        <br>
        <button class="btn-action" onclick="showLogin()">é–‹å§‹éŠæˆ²</button>
    </div>

    <div id="login-screen" class="hidden">
        <h3>å¡«å¯«è³‡æ–™é€²å…¥ç³»çµ±</h3>
        <input type="text" id="class-info" placeholder="ç­ç´š (ä¾‹å¦‚ï¼š204)"><br>
        <input type="text" id="name-info" placeholder="å§“å"><br><br>
        <button class="btn-action" onclick="startGame()">æ­£å¼é–‹è³½</button>
    </div>

    <div id="quiz-screen" class="hidden">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div id="lives-display" class="heart"></div>
            <div id="score-display" style="font-size: 20px; font-weight: bold;">åˆ†æ•¸: 0</div>
        </div>
        <div style="width:100%; background:#eee; height:12px; border-radius:6px; margin:15px 0;">
            <div id="timer-bar"></div>
        </div>
        <p id="progress" style="color: #888;"></p>
        <h2 id="question-text">è¼‰å…¥é¡Œç›®ä¸­...</h2>
        <div id="options-container"></div>
    </div>

    <div id="end-screen" class="hidden">
        <h2 id="end-status"></h2>
        <p id="final-result"></p>
        <div id="review-area" class="hidden">
            <h3 style="color:#ff4757;">éŒ¯é¡Œæª¢è¨</h3>
            <div id="review-list"></div>
        </div>
        <br>
        <button class="btn-action" onclick="location.reload()">å›ä¸»ç•«é¢</button>
    </div>
</div>

<script>
    // 1. Firebase åˆå§‹åŒ–
    const firebaseConfig = {
        apiKey: "AIzaSyDCjJ0h5xFqZxsG-uRFABTTHfs5a_rTFvU",
        authDomain: "b4ch1-1.firebaseapp.com",
        projectId: "b4ch1-1",
        databaseURL: "https://b4ch1-1-default-rtdb.firebaseio.com", // è‹¥æ²’é¡¯ç¤ºè«‹ç¢ºèªæ‚¨çš„RTDBç¶²å€
        storageBucket: "b4ch1-1.firebasestorage.app",
        messagingSenderId: "898873357714",
        appId: "1:898873357714:web:db9fdbd0de3d808f097d4b",
        measurementId: "G-NS0TY5NEKX"
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // 2. é¡Œåº«è³‡æ–™ (8é¡)
    const bank = {
        t1: [{q:"æ•¸åˆ— 5, 9, 13, 17, â–¡", a:"21", o:["19","20","21","22"], h:"å…¬å·® d=4ï¼Œ17+4=21"}, {q:"æ•¸åˆ— 100, 93, 86, â–¡", a:"79", o:["78","79","80","81"], h:"å…¬å·® d=-7"}],
        t2: [{q:"ç­‰å·®æ•¸åˆ—é¦–é … 3, å…¬å·® 5, ç¬¬ 10 é …ç‚º?", a:"48", o:["43","48","53","50"], h:"a10 = 3 + 9Ã—5 = 48"}, {q:"é¦–é … 10, å…¬å·® -2, ç¬¬ 6 é …?", a:"0", o:["0","2","-2","4"], h:"a6 = 10 + 5Ã—(-2) = 0"}],
        t3: [{q:"7 èˆ‡ 13 çš„ç­‰å·®ä¸­é …ç‚ºä½•?", a:"10", o:["9","10","11","12"], h:"(7+13)/2 = 10"}, {q:"-4 èˆ‡ 10 çš„ç­‰å·®ä¸­é …?", a:"3", o:["2","3","4","6"], h:"(-4+10)/2 = 3"}],
        t4: [{q:"æ•¸åˆ— 1, 4, 9, 16, â–¡", a:"25", o:["20","24","25","36"], h:"é€™æ˜¯å¹³æ–¹æ•¸æ•¸åˆ—ï¼Œ5çš„å¹³æ–¹æ˜¯25"}],
        t5: [{q:"ä¸‹åˆ—ä½•è€…æ˜¯ç­‰å·®æ•¸åˆ—?", a:"3, 3, 3, 3", o:["1, 2, 4, 8", "3, 3, 3, 3", "1, 3, 6, 10", "1, -1, 1, -1"], h:"å…¬å·®ç‚º 0 ä¹Ÿæ˜¯ç­‰å·®æ•¸åˆ—"}],
        t6: [{q:"æ­£å—å­˜éŒ¢ç¬¬ä¸€å¤© 10 å…ƒï¼Œä¹‹å¾Œæ¯å¤©å¤š 5 å…ƒï¼Œç¬¬ 8 å¤©å­˜å¤šå°‘?", a:"45", o:["40","45","50","55"], h:"10 + 7Ã—5 = 45"}],
        t7: [{q:"ç­‰å·®æ•¸åˆ— 2, 5, 8... ç¬¬å¹¾é …æ˜¯ 29?", a:"10", o:["9","10","11","12"], h:"29 = 2 + (n-1)Ã—3 -> n=10"}],
        t8: [{q:"ä¸€ç­‰å·®æ•¸åˆ— a3=10, a4=13, å‰‡é¦–é … a1=?", a:"4", o:["1","4","7","10"], h:"d = 13-10=3; a1 = 10 - 2Ã—3 = 4"}]
    };

    let gameQs = [];
    let currentIdx = 0;
    let score = 0;
    let lives = 3;
    let timer;
    let timeLeft;
    let wrongList = [];
    let user = {};

    // 3. æ’è¡Œæ¦œé‚è¼¯ (å¾ Firebase è®€å–)
    function fetchRank() {
        database.ref('leaderboard').orderByChild('score').limitToLast(10).on('value', (snapshot) => {
            const data = [];
            snapshot.forEach(child => { data.push(child.val()); });
            data.reverse();
            document.getElementById('leaderboard-body').innerHTML = data.map((item, i) => `
                <tr><td>${i+1}</td><td>${item.class}</td><td>${item.name}</td><td>${item.score}</td></tr>
            `).join('') || '<tr><td colspan="4">å°šç„¡ç´€éŒ„</td></tr>';
        });
    }

    function showLogin() {
        document.getElementById('start-screen').classList.add('hidden');
        document.getElementById('login-screen').classList.remove('hidden');
    }

    function startGame() {
        user = { 
            class: document.getElementById('class-info').value || "ä¸è©³", 
            name: document.getElementById('name-info').value 
        };
        if(!user.name) return alert("è«‹è¼¸å…¥å§“å");

        // éš¨æ©ŸæŠ½ 8 é¡Œ
        gameQs = [];
        for(let i=1; i<=8; i++) {
            let pool = bank['t'+i];
            gameQs.push(pool[Math.floor(Math.random() * pool.length)]);
        }
        
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('quiz-screen').classList.remove('hidden');
        loadQuestion();
    }

    function loadQuestion() {
        if(currentIdx >= 8 || lives <= 0) return endGame();

        document.getElementById('lives-display').innerHTML = 'â¤ï¸'.repeat(lives);
        document.getElementById('progress').innerText = `é€²åº¦ï¼š${currentIdx + 1} / 8`;
        
        const qData = gameQs[currentIdx];
        document.getElementById('question-text').innerText = qData.q;
        
        const optContainer = document.getElementById('options-container');
        optContainer.innerHTML = '';
        [...qData.o].sort(() => Math.random()-0.5).forEach(opt => {
            const btn = document.createElement('button');
            btn.className = 'option-btn';
            btn.innerText = opt;
            btn.onclick = () => check(opt);
            optContainer.appendChild(btn);
        });

        startTimer();
    }

    function startTimer() {
        timeLeft = 100;
        clearInterval(timer);
        timer = setInterval(() => {
            timeLeft -= 1;
            document.getElementById('timer-bar').style.width = timeLeft + '%';
            if(timeLeft <= 0) { clearInterval(timer); check(null); }
        }, 400); // 40ç§’ä¸€é¡Œ
    }

    function check(pick) {
        clearInterval(timer);
        const q = gameQs[currentIdx];
        if(pick === q.a) {
            score += (100 + timeLeft * 2);
            document.getElementById('score-display').innerText = `åˆ†æ•¸: ${score}`;
        } else {
            lives--;
            wrongList.push(q);
        }
        currentIdx++;
        loadQuestion();
    }

    function endGame() {
        document.getElementById('quiz-screen').classList.add('hidden');
        document.getElementById('end-screen').classList.remove('hidden');
        document.getElementById('end-status').innerText = lives > 0 ? "ğŸ‰ æŒ‘æˆ°æˆåŠŸï¼" : "ğŸ’€ æŒ‘æˆ°å¤±æ•—";
        document.getElementById('final-result').innerText = `${user.name} åŒå­¸ï¼Œç¸½åˆ†ï¼š${score}`;

        // é¡¯ç¤ºéŒ¯é¡Œ
        if(wrongList.length > 0) {
            document.getElementById('review-area').classList.remove('hidden');
            document.getElementById('review-list').innerHTML = wrongList.map(w => `
                <div class="review-card">
                    <b>é¡Œï¼š</b>${w.q} <br>
                    <b style="color:green;">ç­”ï¼š</b>${w.a} <br>
                    <b>è§£ï¼š</b>${w.h}
                </div>
            `).join('');
        }

        // ä¸Šå‚³ Firebase
        database.ref('leaderboard').push({
            class: user.class,
            name: user.name,
            score: score,
            timestamp: Date.now()
        });
    }

    fetchRank();
</script>
</body>
</html>