<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1-1 ç­‰å·®æ•¸åˆ—ï¼šç©åˆ†æŒ‘æˆ°è³½</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <style>
        :root { --main-color: #4834d4; --accent-color: #686de0; --bg-color: #f1f2f6; --text-color: #2f3542; }
        body { font-family: "Microsoft JhengHei", sans-serif; background: var(--bg-color); display: flex; justify-content: center; padding: 20px; color: var(--text-color); }
        #game-container { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 100%; max-width: 800px; text-align: center; position: relative; }
        .hidden { display: none; }
        .heart { color: #ff4757; font-size: 28px; margin-right: 5px; }
        .option-btn { display: block; width: 100%; margin: 12px 0; padding: 15px; font-size: 18px; border: 2px solid var(--accent-color); border-radius: 10px; cursor: pointer; background: white; transition: 0.2s; font-weight: bold; color: var(--text-color); }
        .option-btn:hover { background: var(--accent-color); color: white; transform: translateY(-2px); }
        #timer-bar-bg { width: 100%; background: #dfe4ea; height: 14px; border-radius: 7px; margin: 20px 0; overflow: hidden; }
        #timer-bar { height: 100%; background: #2ed573; width: 100%; transition: width 0.4s linear; }
        
        /* æ’è¡Œæ¦œèˆ‡å¾Œå°è¡¨æ ¼æ¨£å¼ */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; background: #fff; border-radius: 8px; overflow: hidden; }
        th { background: var(--main-color); color: white; padding: 12px; font-size: 16px; }
        td { border-bottom: 1px solid #dfe4ea; padding: 10px; text-align: center; font-size: 15px; }
        
        /* æ’è¡Œæ¦œå‰ä¸‰åé¡è‰² */
        #leaderboard-body tr:nth-child(1) td { color: #e67e22; font-weight: bold; }
        #leaderboard-body tr:nth-child(2) td { color: #7f8fa6; font-weight: bold; }
        #leaderboard-body tr:nth-child(3) td { color: #d35400; font-weight: bold; }

        /* è¼¸å…¥æ¡†èˆ‡æŒ‰éˆ• */
        input[type="text"] { padding: 12px; margin: 8px; width: 70%; border: 2px solid #ced6e0; border-radius: 8px; font-size: 16px; text-align: center; }
        /* æ ¸å–æ–¹å¡Šæ”¾å¤§ */
        input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }

        .btn { background: var(--main-color); color: white; border: none; padding: 12px 30px; border-radius: 8px; cursor: pointer; font-size: 18px; margin-top: 10px; transition: 0.3s; }
        .btn:hover { background: var(--accent-color); }
        .btn-red { background: #ff4757; }
        
        /* éŒ¯é¡Œå€ */
        .review-box { text-align: left; background: #ffeaa7; padding: 15px; margin-bottom: 10px; border-radius: 8px; border-left: 6px solid #fdcb6e; }
        
        /* è€å¸«å¾Œå°éš±è—é» */
        .admin-trigger { cursor: context-menu; user-select: none; }
    </style>
</head>
<body>

<div id="game-container">
    <h1 class="admin-trigger" onclick="checkAdmin()">1-1 ç­‰å·®æ•¸åˆ—æŒ‘æˆ°è³½ ğŸ†</h1>

    <div id="start-screen">
        <h3>ğŸ… æ¦®è­½æ¦œ (å‰ 5 å)</h3>
        <table>
            <thead><tr><th>åæ¬¡</th><th>ç­ç´š</th><th>å§“å</th><th>åˆ†æ•¸</th></tr></thead>
            <tbody id="leaderboard-body">
                <tr><td colspan="4">è³‡æ–™è®€å–ä¸­...</td></tr>
            </tbody>
        </table>
        <br>
        <button class="btn" onclick="showLogin()">æˆ‘è¦æŒ‘æˆ°</button>
    </div>

    <div id="login-screen" class="hidden">
        <h3>åƒè³½è€…ç™»éŒ„</h3>
        <input type="text" id="class-info" placeholder="è¼¸å…¥ç­ç´š (ä¾‹: 801)"><br>
        <input type="text" id="name-info" placeholder="è¼¸å…¥å§“å"><br><br>
        <button class="btn" onclick="startGame()">é–‹å§‹éŠæˆ²</button>
        <br><br>
        <button class="btn btn-red" onclick="location.reload()" style="font-size:14px; padding:8px 15px;">è¿”å›</button>
    </div>

    <div id="quiz-screen" class="hidden">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <div id="lives-display"></div>
            <div id="score-display" style="font-size: 22px; font-weight: bold; color: var(--main-color);">åˆ†æ•¸: 0</div>
        </div>
        
        <div id="timer-bar-bg"><div id="timer-bar"></div></div>
        
        <p id="progress-text" style="color: #747d8c; font-size: 14px;">æº–å‚™é–‹å§‹...</p>
        <h2 id="question-text" style="margin: 20px 0;">é¡Œç›®è¼‰å…¥ä¸­...</h2>
        <div id="options-container"></div>
    </div>

    <div id="end-screen" class="hidden">
        <h2 id="end-status"></h2>
        <p id="final-score" style="font-size: 24px; font-weight: bold; color: var(--main-color);"></p>
        <p style="color: #666; font-size: 14px;">(æˆç¸¾å·²è‡ªå‹•ä¸Šå‚³è‡³æ’è¡Œæ¦œ)</p>
        
        <div id="review-area" class="hidden">
            <h3 style="color: #e17055; border-bottom: 2px solid #fab1a0; padding-bottom: 5px;">âŒ éŒ¯é¡Œè¨‚æ­£</h3>
            <div id="review-list"></div>
        </div>
        <br>
        <button class="btn" onclick="location.reload()">å†ç©ä¸€æ¬¡ / æŸ¥çœ‹æ’è¡Œ</button>
    </div>

    <div id="admin-screen" class="hidden">
        <h2 style="color: #ff4757;">æ•™å¸«ç®¡ç†ä»‹é¢</h2>
        <div style="display: flex; gap: 10px; justify-content: center; margin-bottom: 15px;">
            <button class="btn" onclick="location.reload()" style="font-size: 14px;">é›¢é–‹å¾Œå°</button>
            <button class="btn btn-red" onclick="deleteSelected()" style="font-size: 14px;">åˆªé™¤é¸å–é …ç›®</button>
        </div>
        <div style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd;">
            <table style="width:100%;">
                <thead>
                    <tr>
                        <th style="width: 40px;"><input type="checkbox" id="selectAll" onclick="toggleSelectAll(this)"></th>
                        <th>ç­ç´š</th>
                        <th>å§“å</th>
                        <th>åˆ†æ•¸</th>
                        <th>å®Œæˆæ™‚é–“</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="admin-list">
                    <tr><td colspan="6">è³‡æ–™è¼‰å…¥ä¸­...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // --- 1. Firebase è¨­å®š ---
    const firebaseConfig = {
        apiKey: "AIzaSyDCjJ0h5xFqZxsG-uRFABTTHfs5a_rTFvU",
        authDomain: "b4ch1-1.firebaseapp.com",
        projectId: "b4ch1-1",
        databaseURL: "https://b4ch1-1-default-rtdb.firebaseio.com", 
        storageBucket: "b4ch1-1.firebasestorage.app",
        messagingSenderId: "898873357714",
        appId: "1:898873357714:web:db9fdbd0de3d808f097d4b",
        measurementId: "G-NS0TY5NEKX"
    };
    
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.database();

    // --- 2. éŠæˆ²åƒæ•¸èˆ‡é¡Œåº« ---
    let score = 0;
    let lives = 3;
    let currentIdx = 0;
    let timer;
    let timeLeft;
    let gameQuestions = [];
    let wrongAnswers = [];
    let userInfo = {};

    const questionBank = [
        { q: "æ•¸åˆ— 2, 5, 8, 11, â–¡", a: "14", o: ["13", "14", "15", "16"], h: "å…¬å·® d=3ï¼Œä¸‹ä¸€é …ç‚º 11+3=14" },
        { q: "æ•¸åˆ— 10, 8, 6, â–¡", a: "4", o: ["2", "4", "5", "0"], h: "å…¬å·® d=-2" },
        { q: "ç­‰å·®æ•¸åˆ—é¦–é … a1=5, å…¬å·® d=2, æ±‚ç¬¬ 10 é …?", a: "23", o: ["23", "25", "21", "20"], h: "a10 = 5 + 9Ã—2 = 23" },
        { q: "ç­‰å·®ä¸­é …é¡Œï¼šè‹¥ 4, x, 10 æˆç­‰å·®ï¼Œx=?", a: "7", o: ["6", "7", "8", "5"], h: "(4+10)Ã·2 = 7" },
        { q: "ä¸‹åˆ—ä½•è€…ã€Œä¸æ˜¯ã€ç­‰å·®æ•¸åˆ—?", a: "1, 2, 4, 8", o: ["1, 2, 3, 4", "5, 5, 5, 5", "10, 9, 8, 7", "1, 2, 4, 8"], h: "1, 2, 4, 8 ç‚ºç­‰æ¯”æ•¸åˆ—" },
        { q: "å…¬å¼é¡Œï¼šç¬¬ n é …å…¬å¼ç‚ºä½•?", a: "a1+(n-1)d", o: ["a1+nd", "a1+(n-1)d", "(a1+an)n/2", "a1Ã—r^(n-1)"], h: "åŸºæœ¬å®šç¾©" },
        { q: "æ‡‰ç”¨é¡Œï¼šå°æ˜ç¬¬ä¸€å¤©å­˜10å…ƒï¼Œæ¯å¤©å¤šå­˜2å…ƒï¼Œç¬¬5å¤©å­˜?", a: "18", o: ["16", "18", "20", "22"], h: "10 + 4Ã—2 = 18" },
        { q: "åæ±‚é …æ•¸ï¼š2, 4, 6... å¤šå°‘æ˜¯ç¬¬ 20 é …?", a: "40", o: ["38", "40", "42", "20"], h: "2 + 19Ã—2 = 40" },
        { q: "æ•¸åˆ— -5, -2, 1, â–¡", a: "4", o: ["3", "4", "5", "0"], h: "å…¬å·® d=3" },
        { q: "100, 95, 90... çš„ç¬¬ 6 é …?", a: "75", o: ["70", "75", "80", "85"], h: "100 + 5Ã—(-5) = 75" }
    ];

    // --- 3. æ ¸å¿ƒåŠŸèƒ½ï¼šæ’è¡Œæ¦œ (Top 5) ---
    function loadLeaderboard() {
        db.ref('scores').orderByChild('score').limitToLast(5).on('value', (snapshot) => {
            const list = [];
            snapshot.forEach((child) => {
                list.push(child.val());
            });
            list.reverse(); 

            const tbody = document.getElementById('leaderboard-body');
            if (list.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4">ç›®å‰é‚„æ²’æœ‰äººæŒ‘æˆ°ï¼Œå¿«ä¾†ç•¶ç¬¬ä¸€åï¼</td></tr>';
            } else {
                tbody.innerHTML = list.map((p, i) => `
                    <tr>
                        <td>ç¬¬ ${i + 1} å</td>
                        <td>${p.class}</td>
                        <td>${p.name}</td>
                        <td>${p.score} åˆ†</td>
                    </tr>
                `).join('');
            }
        });
    }

    // --- 4. éŠæˆ²æµç¨‹æ§åˆ¶ ---
    function showLogin() {
        document.getElementById('start-screen').classList.add('hidden');
        document.getElementById('login-screen').classList.remove('hidden');
    }

    function startGame() {
        const cls = document.getElementById('class-info').value.trim();
        const nm = document.getElementById('name-info').value.trim();
        if (!cls || !nm) return alert("è«‹å®Œæ•´è¼¸å…¥ç­ç´šèˆ‡å§“åï¼");

        userInfo = { class: cls, name: nm };
        gameQuestions = [...questionBank].sort(() => 0.5 - Math.random()).slice(0, 8);
        currentIdx = 0; score = 0; lives = 3; wrongAnswers = [];

        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('quiz-screen').classList.remove('hidden');
        loadQuestion();
    }

    function loadQuestion() {
        if (currentIdx >= gameQuestions.length || lives <= 0) return endGame();

        document.getElementById('lives-display').innerHTML = '<span class="heart">â¤ï¸</span>'.repeat(lives);
        document.getElementById('progress-text').innerText = `ç›®å‰é€²åº¦ï¼šç¬¬ ${currentIdx + 1} / 8 é¡Œ`;
        
        const qData = gameQuestions[currentIdx];
        document.getElementById('question-text').innerText = qData.q;
        
        const optsDiv = document.getElementById('options-container');
        optsDiv.innerHTML = "";
        
        let tempOpts = [...qData.o].sort(() => 0.5 - Math.random());
        tempOpts.forEach(opt => {
            const btn = document.createElement('button');
            btn.className = 'option-btn';
            btn.innerText = opt;
            btn.onclick = () => checkAnswer(opt);
            optsDiv.appendChild(btn);
        });
        startTimer();
    }

    function startTimer() {
        timeLeft = 100;
        clearInterval(timer);
        document.getElementById('timer-bar').style.width = "100%";
        document.getElementById('timer-bar').style.backgroundColor = "#2ed573";
        
        timer = setInterval(() => {
            timeLeft--;
            const bar = document.getElementById('timer-bar');
            bar.style.width = timeLeft + "%";
            if(timeLeft < 30) bar.style.backgroundColor = "#ffa502";
            if(timeLeft < 15) bar.style.backgroundColor = "#ff4757";

            if (timeLeft <= 0) {
                clearInterval(timer);
                checkAnswer(null); 
            }
        }, 400); 
    }

    function checkAnswer(ans) {
        clearInterval(timer);
        const qData = gameQuestions[currentIdx];
        
        if (ans === qData.a) {
            score += (100 + timeLeft * 2);
            document.getElementById('score-display').innerText = `åˆ†æ•¸: ${score}`;
        } else {
            lives--;
            wrongAnswers.push(qData);
        }
        currentIdx++;
        loadQuestion();
    }

    function endGame() {
        document.getElementById('quiz-screen').classList.add('hidden');
        document.getElementById('end-screen').classList.remove('hidden');

        document.getElementById('end-status').innerText = lives > 0 ? "ğŸ‰ æŒ‘æˆ°æˆåŠŸï¼" : "ğŸ’” æŒ‘æˆ°çµæŸ";
        document.getElementById('final-score').innerText = `æœ€çµ‚å¾—åˆ†ï¼š${score}`;

        const reviewArea = document.getElementById('review-area');
        if (wrongAnswers.length > 0) {
            reviewArea.classList.remove('hidden');
            document.getElementById('review-list').innerHTML = wrongAnswers.map(w => `
                <div class="review-box">
                    <strong>é¡Œç›®ï¼š</strong>${w.q}<br>
                    <strong style="color:green">æ­£è§£ï¼š${w.a}</strong><br>
                    <span style="color:#666; font-size:0.9em">è§£æï¼š${w.h}</span>
                </div>
            `).join('');
        } else {
            reviewArea.classList.add('hidden');
        }

        db.ref('scores').push({
            class: userInfo.class,
            name: userInfo.name,
            score: score,
            timestamp: firebase.database.ServerValue.TIMESTAMP
        });
    }

    // --- 5. è€å¸«å¾Œå°é‚è¼¯ (å«é¸å–åˆªé™¤) ---
    function checkAdmin() {
        const pwd = prompt("è«‹è¼¸å…¥è€å¸«ç®¡ç†å¯†ç¢¼ï¼š");
        if (pwd === "0904") {
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('admin-screen').classList.remove('hidden');
            loadAdminData();
        } else if (pwd !== null) {
            alert("å¯†ç¢¼éŒ¯èª¤");
        }
    }

    function loadAdminData() {
        db.ref('scores').limitToLast(100).on('value', snapshot => {
            const listDiv = document.getElementById('admin-list');
            listDiv.innerHTML = "";
            let temp = [];
            
            snapshot.forEach(c => {
                temp.push({key: c.key, ...c.val()});
            });
            
            temp.reverse(); // æ–°çš„åœ¨ä¸Šé¢

            // é‡ç½®å…¨é¸æŒ‰éˆ•
            const selectAllBtn = document.getElementById('selectAll');
            if(selectAllBtn) selectAllBtn.checked = false;

            if(temp.length === 0) {
                listDiv.innerHTML = '<tr><td colspan="6">ç›®å‰è³‡æ–™åº«æ˜¯ç©ºçš„</td></tr>';
            } else {
                listDiv.innerHTML = temp.map(item => {
                    let timeStr = "ç„¡ç´€éŒ„";
                    if(item.timestamp) {
                        timeStr = new Date(item.timestamp).toLocaleString();
                    }

                    return `
                        <tr>
                            <td><input type="checkbox" name="recordCb" value="${item.key}"></td>
                            <td>${item.class}</td>
                            <td>${item.name}</td>
                            <td>${item.score}</td>
                            <td style="font-size:14px; color:#555;">${timeStr}</td>
                            <td><button onclick="deleteSingle('${item.key}')" style="background:#ff4757; color:white; border:none; border-radius:4px; cursor:pointer; padding:5px 10px;">åˆªé™¤</button></td>
                        </tr>
                    `;
                }).join('');
            }
        });
    }

    // å…¨é¸åŠŸèƒ½
    function toggleSelectAll(source) {
        const checkboxes = document.getElementsByName('recordCb');
        for(let i=0; i<checkboxes.length; i++) {
            checkboxes[i].checked = source.checked;
        }
    }

    // åˆªé™¤é¸å–é …ç›®
    function deleteSelected() {
        const checkboxes = document.getElementsByName('recordCb');
        const updates = {};
        let count = 0;

        for(let i=0; i<checkboxes.length; i++) {
            if(checkboxes[i].checked) {
                updates[checkboxes[i].value] = null; // åœ¨ Firebase ä¸­è¨­ç‚º null å³ç‚ºåˆªé™¤
                count++;
            }
        }

        if(count === 0) {
            return alert("è«‹å…ˆå‹¾é¸è¦åˆªé™¤çš„è³‡æ–™ï¼");
        }

        if(confirm(`ç¢ºå®šè¦åˆªé™¤é€™ ${count} ç­†è³‡æ–™å—ï¼Ÿ`)) {
            db.ref('scores').update(updates)
                .then(() => {
                    alert("åˆªé™¤æˆåŠŸï¼");
                    document.getElementById('selectAll').checked = false;
                })
                .catch((error) => {
                    alert("åˆªé™¤å¤±æ•—ï¼š" + error.message);
                });
        }
    }

    function deleteSingle(key) {
        if(confirm("ç¢ºå®šåˆªé™¤æ­¤ç­†è³‡æ–™ï¼Ÿ")) db.ref('scores').child(key).remove();
    }

    loadLeaderboard();
</script>
</body>
</html>
