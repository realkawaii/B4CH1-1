<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1-1 ç­‰å·®æ•¸åˆ—ï¼šé›²ç«¯æŒ‘æˆ°è³½</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <style>
        :root { --primary: #1e90ff; --danger: #ff4757; --success: #2ed573; }
        body { font-family: "Microsoft JhengHei", sans-serif; background: #f1f2f6; display: flex; justify-content: center; padding: 20px; }
        #game-container { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); width: 100%; max-width: 700px; text-align: center; position: relative; }
        .hidden { display: none; }
        .heart { color: var(--danger); font-size: 26px; }
        .option-btn { display: block; width: 100%; margin: 10px 0; padding: 14px; font-size: 18px; border: 2px solid #70a1ff; border-radius: 10px; cursor: pointer; background: white; transition: 0.2s; }
        .option-btn:hover { background: #70a1ff; color: white; }
        #timer-bar { height: 12px; background: var(--success); width: 100%; border-radius: 6px; transition: width 0.4s linear; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 14px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
        th { background: var(--primary); color: white; }
        input { padding: 10px; margin: 5px; width: 70%; border: 1px solid #ccc; border-radius: 8px; }
        .btn { background: var(--primary); color: white; border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer; font-size: 16px; margin: 5px; }
        .btn-danger { background: var(--danger); }
        .admin-tag { cursor: pointer; user-select: none; }
        .review-card { text-align: left; background: #fffaf0; padding: 12px; margin-top: 8px; border-left: 5px solid #ffa502; border-radius: 5px; }
    </style>
</head>
<body>

<div id="game-container">
    <h1 class="admin-tag" onclick="checkAdmin()">1-1 ç­‰å·®æ•¸åˆ—æŒ‘æˆ° <span id="admin-icon">ğŸ†</span></h1>

    <div id="start-screen">
        <h3>å…¨æ ¡ç©åˆ†æ’è¡Œæ¦œ</h3>
        <table>
            <thead><tr><th>åæ¬¡</th><th>ç­ç´š</th><th>å§“å</th><th>åˆ†æ•¸</th></tr></thead>
            <tbody id="leaderboard-body"><tr><td colspan="4">è³‡æ–™åŠ è¼‰ä¸­...</td></tr></tbody>
        </table>
        <br>
        <button class="btn" onclick="showLogin()">é–‹å§‹åƒè³½</button>
    </div>

    <div id="admin-screen" class="hidden">
        <h2 style="color:var(--danger)">æ•™å¸«ç®¡ç†å¾Œå°</h2>
        <button class="btn" onclick="location.reload()">é€€å‡ºç®¡ç†</button>
        <button class="btn btn-danger" onclick="deleteAllData()">å…¨é¸åˆªé™¤æ‰€æœ‰è³‡æ–™</button>
        <div style="max-height: 400px; overflow-y: auto;">
            <table>
                <thead><tr><th>ç­ç´š</th><th>å§“å</th><th>åˆ†æ•¸</th><th>æ™‚é–“</th><th>æ“ä½œ</th></tr></thead>
                <tbody id="admin-table-body"></tbody>
            </table>
        </div>
    </div>

    <div id="login-screen" class="hidden">
        <h3>å¡«å¯«è³‡æ–™</h3>
        <input type="text" id="class-info" placeholder="ç­ç´š (å¦‚: 201)"><br>
        <input type="text" id="name-info" placeholder="å§“å"><br><br>
        <button class="btn" onclick="startGame()">ç¢ºèªé€²å…¥éŠæˆ²</button>
    </div>

    <div id="quiz-screen" class="hidden">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div id="lives-display" class="heart"></div>
            <div id="score-display" style="font-size: 20px; font-weight: bold;">åˆ†æ•¸: 0</div>
        </div>
        <div style="width:100%; background:#eee; height:12px; border-radius:6px; margin:15px 0;">
            <div id="timer-bar"></div>
        </div>
        <p id="progress" style="color: #888;"></p>
        <h2 id="question-text">è¼‰å…¥ä¸­...</h2>
        <div id="options-container"></div>
    </div>

    <div id="end-screen" class="hidden">
        <h2 id="end-status"></h2>
        <p id="final-result" style="font-size: 1.2em; font-weight: bold;"></p>
        <div id="review-area" class="hidden">
            <h3 style="color:var(--danger);">éŒ¯é¡Œè§£æ</h3>
            <div id="review-list"></div>
        </div>
        <br>
        <button class="btn" onclick="location.reload()">å›é¦–é </button>
    </div>
</div>

<script>
    // 1. Firebase åˆå§‹åŒ– (è«‹ç¢ºä¿ databaseURL æ˜¯æ­£ç¢ºçš„)
    const firebaseConfig = {
        apiKey: "AIzaSyDCjJ0h5xFqZxsG-uRFABTTHfs5a_rTFvU",
        authDomain: "b4ch1-1.firebaseapp.com",
        projectId: "b4ch1-1",
        databaseURL: "https://b4ch1-1-default-rtdb.firebaseio.com", 
        storageBucket: "b4ch1-1.firebasestorage.app",
        messagingSenderId: "898873357714",
        appId: "1:898873357714:web:db9fdbd0de3d808f097d4b",
        measurementId: "G-NS0TY5NEKX"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // 2. è€å¸«ç®¡ç†åŠŸèƒ½
    function checkAdmin() {
        const pw = prompt("è«‹è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼:");
        if (pw === "0904") {
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('admin-screen').classList.remove('hidden');
            loadAdminData();
        } else if (pw !== null) {
            alert("å¯†ç¢¼éŒ¯èª¤ï¼");
        }
    }

    function loadAdminData() {
        db.ref('scores').on('value', (snapshot) => {
            const list = document.getElementById('admin-table-body');
            list.innerHTML = '';
            snapshot.forEach(child => {
                const val = child.val();
                const date = new Date(val.time).toLocaleString();
                list.innerHTML += `
                    <tr>
                        <td>${val.class}</td>
                        <td>${val.name}</td>
                        <td>${val.score}</td>
                        <td>${date}</td>
                        <td><button class="btn-danger" onclick="deleteData('${child.key}')">åˆªé™¤</button></td>
                    </tr>`;
            });
        });
    }

    function deleteData(id) {
        if(confirm("ç¢ºå®šåˆªé™¤é€™ç­†è³‡æ–™å—ï¼Ÿ")) db.ref('scores').child(id).remove();
    }

    function deleteAllData() {
        if(confirm("ï¼ï¼ï¼ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰ç©å®¶è³‡æ–™å—ï¼Ÿé€™ç„¡æ³•é‚„åŸï¼ï¼ï¼")) db.ref('scores').remove();
    }

    // 3. éŠæˆ²é‚è¼¯èˆ‡é¡Œåº«
    const bank = {
        t1: [{q:"æ•¸åˆ— 5, 9, 13, 17, â–¡", a:"21", o:["19","20","21","22"], h:"d=4, 17+4=21"}, {q:"æ•¸åˆ— 20, 15, 10, â–¡", a:"5", o:["0","5","10","-5"], h:"d=-5"}],
        t2: [{q:"a1=3, d=5, ç¬¬ 10 é …ç‚º?", a:"48", o:["43","48","53","50"], h:"a10 = 3 + 9Ã—5 = 48"}, {q:"a1=10, d=-2, ç¬¬ 6 é …?", a:"0", o:["0","2","-2","4"], h:"a6 = 10 + 5Ã—(-2) = 0"}],
        t3: [{q:"7 èˆ‡ 13 çš„ç­‰å·®ä¸­é …?", a:"10", o:["9","10","11","12"], h:"(7+13)/2 = 10"}, {q:"-4 èˆ‡ 10 çš„ç­‰å·®ä¸­é …?", a:"3", o:["2","3","4","6"], h:"(-4+10)/2 = 3"}],
        t4: [{q:"æ•¸åˆ— 1, 4, 9, 16, â–¡", a:"25", o:["20","24","25","36"], h:"å®Œå…¨å¹³æ–¹æ•¸: 5Â²=25"}],
        t5: [{q:"ä¸‹åˆ—ä½•è€…ã€Œæ˜¯ã€ç­‰å·®æ•¸åˆ—?", a:"3, 3, 3, 3", o:["1, 2, 4, 8", "3, 3, 3, 3", "1, 3, 6, 10", "1, 2, 1, 2"], h:"å…¬å·®ç‚º 0 äº¦å¯"}],
        t6: [{q:"ç¬¬ä¸€å¤©å­˜ 10 å…ƒï¼Œä¹‹å¾Œæ¯å¤©å¤šå­˜ 5 å…ƒï¼Œç¬¬ 8 å¤©å­˜å¤šå°‘?", a:"45", o:["40","45","50","55"], h:"10 + 7Ã—5 = 45"}],
        t7: [{q:"ç­‰å·®æ•¸åˆ— 2, 5, 8... ç¬¬å¹¾é …æ˜¯ 29?", a:"10", o:["9","10","11","12"], h:"29=2+(n-1)3, n=10"}],
        t8: [{q:"a3=10, a4=13, å‰‡é¦–é … a1=?", a:"4", o:["1","4","7","10"], h:"d=3, a1=10-2d=4"}]
    };

    let gameQs = [], currentIdx = 0, score = 0, lives = 3, timer, timeLeft, wrongList = [], user = {};

    function fetchRank() {
        db.ref('scores').orderByChild('score').limitToLast(10).on('value', (snapshot) => {
            const data = [];
            snapshot.forEach(c => data.push(c.val()));
            data.reverse();
            document.getElementById('leaderboard-body').innerHTML = data.map((item, i) => 
                `<tr><td>${i+1}</td><td>${item.class}</td><td>${item.name}</td><td>${item.score}</td></tr>`
            ).join('') || '<tr><td colspan="4">ç›®å‰å°šç„¡æ•¸æ“š</td></tr>';
        });
    }

    function showLogin() {
        document.getElementById('start-screen').classList.add('hidden');
        document.getElementById('login-screen').classList.remove('hidden');
    }

    function startGame() {
        user = { class: document.getElementById('class-info').value || "æœªå¡«", name: document.getElementById('name-info').value };
        if(!user.name) return alert("è«‹è¼¸å…¥å§“å");

        gameQs = [];
        for(let i=1; i<=8; i++) {
            let pool = bank['t'+i];
            gameQs.push(pool[Math.floor(Math.random() * pool.length)]);
        }
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('quiz-screen').classList.remove('hidden');
        loadQuestion();
    }

    function loadQuestion() {
        if(currentIdx >= 8 || lives <= 0) return endGame();
        document.getElementById('lives-display').innerHTML = 'â¤ï¸'.repeat(lives);
        document.getElementById('progress').innerText = `é¡Œç›® ${currentIdx + 1} / 8`;
        const qData = gameQs[currentIdx];
        document.getElementById('question-text').innerText = qData.q;
        const container = document.getElementById('options-container');
        container.innerHTML = '';
        [...qData.o].sort(()=>Math.random()-0.5).forEach(opt => {
            const b = document.createElement('button');
            b.className = 'option-btn';
            b.innerText = opt;
            b.onclick = () => check(opt);
            container.appendChild(b);
        });
        startTimer();
    }

    function startTimer() {
        timeLeft = 100;
        clearInterval(timer);
        timer = setInterval(() => {
            timeLeft -= 1;
            document.getElementById('timer-bar').style.width = timeLeft + '%';
            if(timeLeft <= 0) { clearInterval(timer); check(null); }
        }, 400); 
    }

    function check(pick) {
        clearInterval(timer);
        const q = gameQs[currentIdx];
        if(pick === q.a) {
            score += (100 + timeLeft * 2);
        } else {
            lives--;
            wrongList.push(q);
        }
        currentIdx++;
        loadQuestion();
    }

    function endGame() {
        document.getElementById('quiz-screen').classList.add('hidden');
        document.getElementById('end-screen').classList.remove('hidden');
        document.getElementById('end-status').innerText = lives > 0 ? "ğŸ‰ æ­å–œå®Œè³½ï¼" : "ğŸ’€ æŒ‘æˆ°å¤±æ•—";
        document.getElementById('final-result').innerText = `${user.name} çš„æœ€çµ‚åˆ†æ•¸ï¼š${score}`;

        if(wrongList.length > 0) {
            document.getElementById('review-area').classList.remove('hidden');
            document.getElementById('review-list').innerHTML = wrongList.map(w => `
                <div class="review-card"><b>é¡Œç›®ï¼š</b>${w.q}<br><b style="color:green">æ­£è§£ï¼š${w.a}</b><br>è§£æï¼š${w.h}</div>
            `).join('');
        }
        db.ref('scores').push({ class: user.class, name: user.name, score: score, time: Date.now() });
    }

    fetchRank();
</script>
</body>
</html>
